
#---------------------------------------
# Docker jobs

#----------
# Base jobs

.on-amd64: &on-amd64
  tags:
    - docker-amd64
  variables:
    cpuArch: "amd64"

.on-arm64: &on-arm64
  tags:
    - docker-arm64
  variables:
    cpuArch: "arm64"

.docker-job:
  image: docker:24-cli
  variables:
    # does not use source code
    GIT_STRATEGY: none
  dependencies: []
  only:
    - tags

.docker-auth-job:
  extends: .docker-job
  before_script:
    # - echo "${REGISTRY_PASSWORD}" | docker login --username ${REGISTRY_USERNAME} --password-stdin ${REGISTRY_HOST}
    # if username and password given then login, otherwise assume runner is already authenticated
    - if [ -n "${REGISTRY_PASSWORD:-}" ] && [ -n "${REGISTRY_USERNAME:-}" ]; then echo "${REGISTRY_PASSWORD}" | docker login --username "${REGISTRY_USERNAME}" --password-stdin "${REGISTRY_HOST}"; fi

#----------
# Create manifest
# Create docker manifest list for tag :version
create-manifest:
  stage: docker-publish-manifests
  extends: .docker-auth-job
  script:
    - docker manifest create --insecure $REGISTRY_IMAGE_VER $REGISTRY_IMAGE_VER-amd64 $REGISTRY_IMAGE_VER-arm64
    - docker manifest push --insecure --purge $REGISTRY_IMAGE_VER

#----------
# Create tag :latest

# Create docker manifest list for tag :latest
create-latest-tag:
  stage: docker-publish-manifests
  extends: .docker-auth-job
  only:
    # Checking the format of the Git tag is the only thing that works
    # We cannot check for example if the tag is on the master branch
    - /^\d+\.\d+\.\d+$/
  script:
    - docker manifest create --insecure $REGISTRY_IMAGE_BASE:latest $REGISTRY_IMAGE_VER-amd64 $REGISTRY_IMAGE_VER-arm64
    - docker manifest push --insecure --purge $REGISTRY_IMAGE_BASE:latest

#----------
# Cleanup

# Remove docker image for amd64
cleanup-amd64:
  <<: *on-amd64
  extends: .remove-image-base

## Remove docker image for arm64
cleanup-arm64:
  <<: *on-arm64
  extends: .remove-image-base

# Base task for removing built Docker image
.remove-image-base:
  extends: .docker-job
  stage: docker-cleanup-images
  script:
    - docker image rm -f $REGISTRY_IMAGE_VER-$cpuArch

